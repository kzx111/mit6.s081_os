# lab9 : file system

## large files

* 您将更改xv6文件系统代码，以支持每个索引节点中的“双间接”块，该块包含256个单间接块地址，每个块最多可包含256个数据块地址。结果是，一个文件最多可以包含65803个块，即256*256+256+11个块（11个而不是12个，因为我们将为双间接块牺牲一个直接块号）。
* 关键点：fs.h 中  `NDIRECT`, `NINDIRECT`, `MAXFILE`， the `addrs[]` element of `struct dinode`.

在磁盘上查找文件数据的代码位于fs.c中的bmap（）中。请查看它，确保您了解它的功能。bmap（）在读取和写入文件时都会被调用。写入时，bmap（）会根据需要分配新块来保存文件内容，并在需要时分配间接块来保存块地址。
bmap（）处理两种类型的块编号。bn参数是一个“逻辑块号”，即文件中相对于文件开头的块号。ip->addrs[]中的块号和bread（）的参数是磁盘块号。您可以将bmap（）视为将文件的逻辑块号映射到磁盘块号。

* 任务：修改bmap（），使其除了直接块和单间接块外，还实现了双间接块。你只需要11个直接块，而不是12个，就可以为你的新双间接块腾出空间；不允许更改磁盘上inode的大小。ip->addrs[]的前11个元素应该是直接块；第12个应该是一个单独的间接块（就像当前的块一样）；13号应该是你的新双间接街区。当bigfile写入65803个块并且用户测试成功运行时，您就完成了此练习







* 提示：
* * 确保你理解bmap（）。写出ip->addrs[]、间接块、双间接块和它所指向的单间接块以及数据块之间的关系图。确保你理解为什么添加双间接块会使最大文件大小增加256*256个块（实际上是减一，因为你必须将直接块的数量减少一个）。
  * 考虑一下如何用逻辑块号对双间接块及其指向的间接块进行索引。
  * 如果更改NDIRECT的定义，则可能必须更改file.h中struct inode中addrs[]的声明。请确保struct inode和struct dinode在其addrs[]数组中具有相同数量的元素。
  * 如果更改NDIRECT的定义，请确保创建一个新的fs.img，因为mkfs使用NDIRECT构建文件系统。
  * 如果您的文件系统进入不良状态，可能是崩溃，请删除fs.img（从Unix中执行此操作，而不是xv6）。make将为您构建一个新的干净文件系统映像。
  * 别忘了对每个块进行bread（）。
  * 您应该只根据需要分配间接块和双间接块，就像原始的bmap（）一样。
  * 确保itrunc释放文件的所有块，包括双间接块。



![](..\pic\doubleinode.png)



## soft link

在本练习中，您将向xv6添加符号链接。符号链接（或软链接）是指按路径名链接的文件；当打开符号链接时，内核会按照链接指向引用的文件。符号链接类似于硬链接，但硬链接仅限于指向同一磁盘上的文件，而符号链接可以跨磁盘设备。虽然xv6不支持多个设备，但实现此系统调用是理解路径名查找工作原理的一个很好的练习。



任务：您将实现symlink（char*target，char*path）系统调用，该调用在引用目标命名的文件的路径处创建一个新的符号链接。有关更多信息，请参阅手册页符号链接。要进行测试，请将symlinkstest添加到Makefile中并运行它。





提示：

1. 首先，为symlink创建一个新的系统调用号，在user/usys.pl、user/user.h中添加一个条目，并在kernel/sysfile.c中实现一个空的sys_symlink。
2. 在kernel/stat.h中添加一个新的文件类型（T_SYMLINK）来表示符号链接。
3. 在kernel/fcntl.h中添加一个新标志（O_NOFOLLOW），该标志可用于开放系统调用。请注意，传递给open的标志是使用位OR运算符组合的，因此您的新标志不应与任何现有标志重叠。这将允许您在将user/symlinktest.c添加到Makefile后对其进行编译。
4. 实现symlink（target，path）系统调用，在引用目标的路径处创建一个新的符号链接。请注意，系统调用成功不需要目标存在。您需要选择一个位置来存储符号链接的目标路径，例如，在索引节点的数据块中。符号链接应该返回一个表示成功（0）或失败（-1）的整数，类似于链接和取消链接。
5. 修改开放系统调用以处理路径引用符号链接的情况。如果文件不存在，打开必须失败。当一个进程在要打开的标志中指定O_NOFOLLOW时，open应该打开符号链接（而不是遵循符号链接）。
6. 如果**链接文件也是符号链接**，则必须递归地跟随它，直到到达非链接文件。如果链接形成循环，则必须返回错误代码。如果链接深度达到某个阈值（例如10），您可以通过返回错误代码来近似计算。
7. 其他系统调用（例如，链接和取消链接）不得遵循符号链接；这些系统调用对符号链接本身进行操作。
   您不必处理指向此实验室目录的符号链接。



![](..\pic\softlink.jpg)